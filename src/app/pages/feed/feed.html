<div class="feed-container">
  <h1>VibeBooks</h1>

  @if (isLoading() && feedItems().length === 0) {
    <p class="loading-message">Carregando o feed...</p>
  }

  @if (feedItems().length > 0) {
    <div class="feed-list">
      @for (book of feedItems(); track book.id) {
        <div class="feed-card">
          <div class="book-info">
            <img [ngSrc]="book.coverImageUrl" [alt]="book.title" class="book-cover" width="80" height="120">
            <div class="book-details">
              <h2>{{ book.title }}</h2>
              <p class="author">por {{ book.author }} ({{ book.publicationYear }})</p>

              <div class="book-like-action">
                <button class="action-btn like-btn" (click)="likeBook(book.id)" [class.liked]="book.likedByCurrentUser">
                  <i [class]="book.likedByCurrentUser ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                  {{ book.likesCount > 0 ? book.likesCount : '' }} Amei
                </button>
              </div>
            </div>
          </div>

          <div class="book-status-actions">
            @for (status of statusOptions; track status.key) {
              <button
                class="status-btn"
                [class.active]="book.status === status.key" (click)="handleStatusClick(book, status.key)">
                {{ status.label }}
              </button>
            }
          </div>

          <div class="sentiment-actions"
               [class.disabled]="book.status !== 'READING' && book.status !== 'READ'" title="{{ (book.status !== 'READING' && book.status !== 'READ') ? 'Marque como Lendo ou Lido para definir um sentimento' : '' }}"> @for (sentiment of sentimentOptions; track sentiment.key) {
            <button
              class="sentiment-btn"
              [class.active]="book.sentiment === sentiment.key" (click)="handleSentimentClick(book, sentiment.key)">
              {{ sentiment.label }}
            </button>
            }
          </div>

          <div class="card-actions">
            <button class="action-btn" (click)="toggleComments(book.id)">
              <i class="fa-regular fa-comment"></i> Comentários
            </button>
          </div>

          @if (commentsVisibility().get(book.id)) {
            <div class="comments-section-expanded">
              @if (commentsLoading().get(book.id) && commentsMap().get(book.id)?.length === 0) {
                <p class="comments-loading">Carregando comentários...</p>
              } @else {
                <form [formGroup]="commentForms.get(book.id)!" (ngSubmit)="postComment(book.id)" class="comment-form">
                  <input type="text" formControlName="text" placeholder="Escreva um comentário...">
                  <button type="submit" class="btn-primary" [disabled]="commentForms.get(book.id)!.invalid">Postar</button>
                </form>

                <div class="comments-list">
                  @for (comment of commentsMap().get(book.id)!; track comment.id) {
                    <div class="comment">
                      <div class="comment-header">
                        <span class="comment-author">{{ comment.username }}</span>
                        @if (currentUser && comment.userId === currentUser.id) {
                          <button class="delete-btn" (click)="deleteComment(comment.id, book.id)" title="Excluir comentário">&times;</button>
                        }
                      </div>
                      <p class="comment-text">{{ comment.text }}</p>
                      <div class="comment-footer">
                        <button class="action-btn like-btn" (click)="likeComment(comment.id, book.id)" [class.liked]="comment.likedByCurrentUser">
                          <i [class]="comment.likedByCurrentUser ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                          {{ comment.likesCount > 0 ? comment.likesCount : '' }} Amei
                        </button>
                      </div>
                    </div>
                  } @empty {
                    @if (!commentsLoading().get(book.id)) {
                      <p class="no-comments">Nenhum comentário ainda. Seja o primeiro!</p>
                    }
                  }
                </div>

                @if (commentPaginationState().get(book.id); as state) {
                  @if (state.currentPage + 1 < state.totalPages && !state.loadingMore) {
                    <button class="load-more-btn" (click)="loadMoreComments(book.id)">
                      Carregar mais comentários
                    </button>
                  }
                  @if (state.loadingMore) {
                    <p class="comments-loading more-loading">Carregando...</p>
                  }
                }
              }
            </div>
          }
        </div>
      }
    </div>
  }

  @if (!isLoading() && feedItems().length === 0) {
    <p class="empty-feed-message">Seu feed está vazio.</p>
  }
</div>
