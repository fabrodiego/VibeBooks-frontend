@if (isLoadingBook()) {
  <div class="loading-container"> <mat-spinner diameter="50"></mat-spinner> </div>
} @else if (book(); as bookData) {
  <h1 mat-dialog-title>{{ bookData.title }}</h1>
  <mat-dialog-content class="mat-typography">

    <div class="book-details-layout">
      <div class="book-cover-column">
        <img [ngSrc]="bookData.coverImageUrl" [alt]="bookData.title" class="book-cover" width="150" height="225">
      </div>
      <div class="book-actions-column">
        <div class="book-text-details">
          <p class="author">por {{ bookData.author }}</p>
          <p class="year">Publicado em {{ bookData.publicationYear }}</p>
        </div>
        <div class="book-like-action">
          <button
            class="action-btn like-btn"
            (click)="likeBook(bookData)"
            [class.liked]="bookData.likedByCurrentUser">
            <i [class]="bookData.likedByCurrentUser ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
            {{ bookData.likesCount > 0 ? bookData.likesCount : '' }} Amei
          </button>
        </div>
        <div class="book-status-actions">
          @for (status of statusOptions; track status.key) {
            <button
              class="status-btn"
              [class.active]="bookData.status === status.key"
              (click)="handleStatusClick(bookData, status.key)">
              {{ status.label }}
            </button>
          }
        </div>
        <div class="sentiment-actions"
             [class.disabled]="bookData.status !== 'READING' && bookData.status !== 'READ'"
             title="{{ (bookData.status !== 'READING' && bookData.status !== 'READ') ? 'Marque como Lendo ou Lido para definir um sentimento' : '' }}">

          @for (sentiment of sentimentOptions; track sentiment.key) {
            <button
              class="sentiment-btn"
              [class.active]="bookData.sentiment === sentiment.key"
              (click)="handleSentimentClick(bookData, sentiment.key)">
              {{ sentiment.label }}
            </button>
          }
        </div>

        <div class="community-sentiments-container">
          <h3>Sentimentos da Comunidade</h3>
          <div class="community-sentiments-list">
            @for (sentiment of communitySentiments(); track sentiment.label) {
              <span class="sentiment-badge">
                {{ sentiment.label }}
                <span class="sentiment-count">{{ sentiment.count }}</span>
              </span>
            } @empty {
              <p class="no-sentiments">
                Seja o primeiro a registrar um sentimento para este livro.
              </p>
            }
          </div>
        </div>
      </div>
    </div>

    <div class="comments-container">

      <div class="comments-toggle-header" (click)="toggleCommentsVisibility()">
        <h2>Comentários</h2>
        <i [class]="isCommentsVisible() ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"></i>
      </div>

      @if (isCommentsVisible()) {
        <div class="comments-list-wrapper"> @if (isLoadingComments() && comments().length === 0) {
          <p class="comments-loading">Carregando comentários...</p>
        } @else {
          <div class="comments-list">
            @for (comment of comments(); track comment.id) {
              <div class="comment">
                <div class="comment-header">
                  <span class="comment-author">{{ comment.username }}</span>
                  @if (currentUser && comment.userId === currentUser.id) {
                    <button class="delete-btn" (click)="deleteComment(comment.id)" title="Excluir comentário">&times;</button>
                  }
                </div>
                <p class="comment-text">{{ comment.text }}</p>
                <div class="comment-footer">
                  <button class="action-btn like-btn" (click)="likeComment(comment.id)" [class.liked]="comment.likedByCurrentUser">
                    <i [class]="comment.likedByCurrentUser ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"></i>
                    {{ comment.likesCount > 0 ? comment.likesCount : '' }} Curtir
                  </button>
                </div>
              </div>
            } @empty {
              @if (!isLoadingComments()) {
                <p class="no-comments">Nenhum comentário ainda.</p>
              }
            }
          </div>

          @if (commentPagination(); as state) {
            @if (state.currentPage + 1 < state.totalPages && !state.loadingMore) {
              <button class="load-more-btn" (click)="loadMoreComments()">
                Carregar mais comentários
              </button>
            }
            @if (state.loadingMore) {
              <p class="comments-loading more-loading">Carregando...</p>
            }
          }
        }
        </div>
      }
    </div>

  </mat-dialog-content>
}
